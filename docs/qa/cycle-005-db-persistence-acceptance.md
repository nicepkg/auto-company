# Cycle 005 DB Persistence Acceptance

Date: 2026-02-13

Scope: accept the hosted workflow as “DB-persisted” only when Supabase contains verifiable run and event records for a customer-originated intake run ID.

## Preconditions

- Supabase migration applied:
  - `projects/security-questionnaire-autopilot/supabase/migrations/20260213_cycle003_hosted_workflow.sql`
- Supabase seed applied:
  - `projects/security-questionnaire-autopilot/supabase/seed/pilot-001-floor-pricing.sql`
- Hosted runtime env vars set:
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `SUPABASE_SERVICE_ROLE_KEY`

## Required Evidence Artifacts

One of:
- Hosted API evidence: `POST /api/workflow/db-evidence` response JSON for the run ID, or
- Direct DB evidence: JSON generated by `node projects/security-questionnaire-autopilot/scripts/fetch-db-evidence.mjs <runId> <outFile>`

## Pass Criteria

- `workflow_runs` contains exactly one row with:
  - `run_id == <runId>`
  - `status in ('drafted','approved','exported')` (target: `exported`)
- Schema identity matches expected (prevents “evidence against the wrong schema”):
  - `workflow_app_meta.meta_key='schema_bundle_id'` has `meta_value='20260213_cycle003_hosted_workflow'`
  - `workflow_runs.metadata.schema_bundle_sha256` matches `projects/security-questionnaire-autopilot/supabase/bundles/workflow-schema-version.json` `bundleSha256`
- `workflow_events` contains at least these steps for the same `run_id`:
  - `ingest` with `status='success'`
  - `draft` with `status='success'`
  - `approve` with `status='success'`
  - `export` with `status='success'`
- Gate parity remains intact:
  - export manifest shows `gates.all_cited=true` and `gates.human_approved=true`

## Fail Criteria

- No `workflow_runs` row for the run ID.
- `workflow_runs.status='failed'` after a completed hosted API run.
- Missing any required `workflow_events` step for the run ID.
- Event steps exist but show `status='failed'` for a flow that otherwise “passed” in file artifacts.

## Notes / Risks

- `validate-pilot-deal` is currently recorded as an event only (not persisted into `pilot_deals` table by code). This is acceptable for Cycle 005 persistence proof as long as core workflow steps persist.

## Next Action
Run one customer-originated hosted intake with Supabase env vars set and capture the DB evidence JSON for attachment into the sales execution ledger.
