# Cycle 005 Hosted Supabase Apply + Redeploy + Evidence (QA-Bach Execution Report)

Date (UTC): 2026-02-13
Workspace: `/home/zjohn/autocomp/auto-company`
Target project: `projects/security-questionnaire-autopilot`

## Objective (Definition Of Done)
1. Apply hosted Supabase schema + seed bundle (must include `public.workflow_app_meta`):
   - `projects/security-questionnaire-autopilot/supabase/bundles/20260213_cycle003_hosted_workflow_migration_plus_seed.sql`
2. Hosted Next.js runtime is configured and redeployed with:
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `SUPABASE_SERVICE_ROLE_KEY`
3. Run Cycle 005 wrapper against the real deployed `BASE_URL`:
   - `projects/security-questionnaire-autopilot/scripts/cycle-005-hosted-supabase-apply-and-run.sh "$BASE_URL" "$RUN_ID"`
4. Generate and append run-id-specific DB evidence:
   - `docs/devops/cycle-005-supabase-persistence-<run_id>.json`
   - Append entry to `docs/sales/cycle-003-hosted-workflow-pilot-001-execution.md` under `## Cycle 005 DB Persistence Evidence Log`

## What I Could Execute In This Workspace
### 1) Bundle correctness checks (local)
Verified the SQL bundle contains the required schema identity table and schema bundle marker:
- `create table if not exists public.workflow_app_meta (...)`
- `insert into public.workflow_app_meta ... ('schema_bundle_id','20260213_cycle003_hosted_workflow',...) on conflict ...`

Evidence:
- `docs/qa-bach/cycle-005-bundle-verify-2026-02-13.txt` (bundle verification: PASS + SHA256s)
- `projects/security-questionnaire-autopilot/supabase/bundles/20260213_cycle003_hosted_workflow_migration_plus_seed.sql`

### 2) Hosted `BASE_URL` discovery attempts (no credentials)
Probed common likely hostnames for:
- `GET /api/workflow/env-health`

All candidates returned Vercel `DEPLOYMENT_NOT_FOUND` (or DNS failure previously for Pages).

Evidence:
- `docs/qa-bach/cycle-005-base-url-probe-2026-02-13.txt`
- `docs/qa-bach/cycle-005-base-url-probe-2026-02-13-v2.txt`

### 3) Execution path analysis (wrapper requirements)
Cycle 005 wrapper hard-gates on the remote runtime being correctly configured:
- It calls `GET $BASE_URL/api/workflow/env-health` and requires:
  - `.ok == true`
  - `.env.NEXT_PUBLIC_SUPABASE_URL == true`
  - `.env.SUPABASE_SERVICE_ROLE_KEY == true`
- It then calls `GET $BASE_URL/api/workflow/supabase-health?requireSeed=1&requirePilotDeals=1` and requires `.ok == true`.
- It runs a customer-originated intake via:
  - `projects/security-questionnaire-autopilot/scripts/hosted-workflow-customer-intake.sh`
- It captures DB evidence primarily via hosted endpoint:
  - `POST $BASE_URL/api/workflow/db-evidence`
  - Falls back to PostgREST only if hosted evidence is unavailable (requires local `NEXT_PUBLIC_SUPABASE_URL` + `SUPABASE_SERVICE_ROLE_KEY`).

Reference:
- `projects/security-questionnaire-autopilot/scripts/cycle-005-hosted-supabase-apply-and-run.sh`

## Blockers (Why DOD Could Not Be Completed Here)
1. No real deployed `BASE_URL` is present in-repo, and probes did not find a reachable deployment.
2. No Supabase production credentials are available in this runtime:
   - `SUPABASE_DB_URL` is unset (required to apply SQL from here, unless you apply via Dashboard SQL Editor and rerun with `SKIP_SUPABASE_SQL_APPLY=1`).
3. The GitHub Actions workflows under `.github/workflows/` exist locally but are currently untracked in git here; they are not available in the upstream repo’s Actions API from this workspace (so they cannot be used as a credentialed execution path until committed/pushed).

## Fastest Credentialed Apply Path (Minimal Tooling)
1. Apply the paste-ready bundle in Supabase Dashboard SQL Editor:
   - `projects/security-questionnaire-autopilot/supabase/bundles/20260213_cycle003_hosted_workflow_migration_plus_seed.sql`
2. In the hosting provider UI (Vercel/Render/etc), set and redeploy/restart:
   - `NEXT_PUBLIC_SUPABASE_URL`
   - `SUPABASE_SERVICE_ROLE_KEY`
3. Confirm runtime sees the vars (no secrets returned):
   - `curl -sS "$BASE_URL/api/workflow/env-health" | jq .`
4. Run the wrapper from a credentialed shell (this repo workspace) with:
   - `export SKIP_SUPABASE_SQL_APPLY=1`
   - `./projects/security-questionnaire-autopilot/scripts/cycle-005-hosted-supabase-apply-and-run.sh "$BASE_URL" "$RUN_ID"`

## QA Risk Note (High-Value Unknown)
Prior “hosted” runs in `projects/security-questionnaire-autopilot/runs/*` are consistent with defaulting to `http://localhost:3000` unless a real `BASE_URL` was supplied. If the goal is production confidence, insist on evidence generated by the Cycle 005 wrapper against the actual deployed `BASE_URL` plus Supabase persistence enabled.

## Next Action (Handoff)
Provide the real deployed `BASE_URL` for the hosted Next.js app and confirm where it is hosted (provider + project name). Once those exist, I will run:
- `./projects/security-questionnaire-autopilot/scripts/cycle-005-hosted-supabase-apply-and-run.sh "$BASE_URL" "$RUN_ID"`
to generate persistence evidence and auto-append the sales ledger entry.

