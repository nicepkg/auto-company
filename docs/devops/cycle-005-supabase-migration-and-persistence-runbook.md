# Cycle 005 DevOps Runbook: Supabase Migration + Seed + Persistence Evidence

Date: 2026-02-13
Owner: devops-hightower

## Goal
1. Apply Supabase migration + seed to the target hosted Supabase Postgres project.
2. Rerun one customer-originated hosted intake.
3. Capture DB persistence evidence from `workflow_runs` and `workflow_events`.
4. Attach the evidence artifact path into `docs/sales/cycle-003-hosted-workflow-pilot-001-execution.md`.

## Inputs Required (Real Credentials)
- Hosted runtime env vars (set on the deployed Next.js environment, not in your local shell):
  - `NEXT_PUBLIC_SUPABASE_URL`
  - `SUPABASE_SERVICE_ROLE_KEY`
- Optional local env vars:
  - `SUPABASE_DB_URL`: only required if you want the wrapper to apply SQL via `node + pg`.
  - `NEXT_PUBLIC_SUPABASE_URL` + `SUPABASE_SERVICE_ROLE_KEY`: only required if the wrapper must fall back to direct PostgREST evidence fetch (normally it uses the hosted `/api/workflow/db-evidence` endpoint).

## If You Only Have Dashboard Access (No DB URL)
Use the Supabase SQL Editor flow in:
- `docs/devops/cycle-005-credentialed-supabase-apply-runbook.md`

That runbook includes a single paste-ready SQL bundle (migration + seed):
- `projects/security-questionnaire-autopilot/supabase/bundles/20260213_cycle003_hosted_workflow_migration_plus_seed.sql`

Note: the bundle also seeds `public.workflow_app_meta.schema_bundle_id = '20260213_cycle003_hosted_workflow'`.
The hosted `/api/workflow/supabase-health` endpoint validates this by default to prevent schema/evidence mismatch.

## One-Command Execution
This wrapper does:
- apply migration SQL + seed SQL
- run hosted intake steps against a given `BASE_URL`
- fetch persistence evidence JSON
- (and auto-appends the evidence path into the sales execution ledger)

```bash
export SUPABASE_DB_URL='...' # optional; omit if SQL already applied via Dashboard

./projects/security-questionnaire-autopilot/scripts/cycle-005-hosted-supabase-apply-and-run.sh \
  https://<your-hosted-nextjs-base-url> \
  pilot-001-customer-originated-$(date +%Y%m%d-%H%M%S)
```

If you already applied SQL via the Supabase Dashboard SQL Editor, you can skip the DB apply step:

```bash
export SKIP_SUPABASE_SQL_APPLY=1

./projects/security-questionnaire-autopilot/scripts/cycle-005-hosted-supabase-apply-and-run.sh \
  https://<your-hosted-nextjs-base-url> \
  pilot-001-customer-originated-$(date +%Y%m%d-%H%M%S)
```

Outputs:
- API step evidence JSON: `docs/qa/cycle-005-hosted-*-<run_id>.json`
- Supabase health check JSON: `docs/qa/cycle-005-supabase-health-<run_id>.json`
- DB persistence evidence JSON: `docs/devops/cycle-005-supabase-persistence-<run_id>.json`
- Sales ledger updated: `docs/sales/cycle-003-hosted-workflow-pilot-001-execution.md`

Note: the wrapper calls `GET /api/workflow/supabase-health?requireSeed=1&requirePilotDeals=1` to prevent "schema applied but wrong project / seed missing" evidence mismatches.

Lowest-friction persistence proof (no local Supabase creds required):
- `/tmp/hosted-intake-<run_id>/responses/06-db-evidence.json.pretty`
  - generated by `projects/security-questionnaire-autopilot/scripts/hosted-workflow-customer-intake.sh`

Strict hosted Supabase preflight (recommended for Cycle 005):
- `GET /api/workflow/supabase-health?requireSeed=1&requirePilotDeals=1`

## Node Version Pin
- Project pin: `projects/security-questionnaire-autopilot/.nvmrc`
- If you use `nvm`:
  - `cd projects/security-questionnaire-autopilot && nvm use`

## Dashboard Evidence Queries (No DB URL)
If you only have Supabase Dashboard access, run the SQL in:
- `docs/devops/cycle-005-dashboard-sql-evidence-queries.sql`

## Rollback Plan
- Migration uses `create table if not exists` and `create index if not exists`.
- If you need to revert, drop tables in reverse dependency order:
  - `drop table if exists public.workflow_events;`
  - `drop table if exists public.pilot_deals;`
  - `drop table if exists public.workflow_runs;`

## Known Risks
- Node version drift between machines (local shells, CI, and hosted runtime).
  - Mitigation: `projects/security-questionnaire-autopilot/.nvmrc` + wrapper preflight (Node 18+ required, Node 20+ recommended).
- Secrets leakage via shell history.
  - Mitigation: avoid pasting secrets into terminals; use your secret manager and set hosted env vars in your deployment platform UI.

## Artifacts
- Paste-ready bundle (migration + seed): `projects/security-questionnaire-autopilot/supabase/bundles/20260213_cycle003_hosted_workflow_migration_plus_seed.sql`
- Migration SQL: `projects/security-questionnaire-autopilot/supabase/migrations/20260213_cycle003_hosted_workflow.sql`
- Seed SQL: `projects/security-questionnaire-autopilot/supabase/seed/pilot-001-floor-pricing.sql`
- Wrapper script: `projects/security-questionnaire-autopilot/scripts/cycle-005-hosted-supabase-apply-and-run.sh`
- SQL apply script: `projects/security-questionnaire-autopilot/scripts/apply-supabase-sql.mjs`
- Evidence fetch script: `projects/security-questionnaire-autopilot/scripts/fetch-supabase-workflow-evidence.mjs`
- Attempt log (no-creds env): `docs/devops/cycle-005-supabase-migration-attempt.txt`
