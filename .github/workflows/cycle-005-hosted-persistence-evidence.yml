name: cycle-005-hosted-persistence-evidence

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: "Optional: 2-4 candidate BASE_URLs (comma/space/newline separated). If empty, uses repo variable HOSTED_WORKFLOW_BASE_URL_CANDIDATES (recommended), then falls back to legacy vars (CYCLE_005_BASE_URL_CANDIDATES, HOSTED_BASE_URL_CANDIDATES, WORKFLOW_APP_BASE_URL_CANDIDATES), then GitHub Deployments discovery (if present). Candidates must be the deployed Next.js app serving /api/workflow/* (not marketing/static site)."
        required: false
        default: ""
      base_url_candidates:
        description: "Alias for base_url (same semantics). Prefer setting repo variable HOSTED_WORKFLOW_BASE_URL_CANDIDATES once instead of providing input every run."
        required: false
        default: ""
      run_id:
        description: "Optional explicit run id. If empty, one is generated."
        required: false
        default: ""
      skip_sql_apply:
        description: "Skip applying the Supabase SQL bundle (recommended if already applied via Dashboard SQL Editor)"
        type: boolean
        required: true
        default: true
      sql_bundle:
        description: "Workspace-relative path to SQL bundle to apply when skip_sql_apply=false"
        required: true
        default: "projects/security-questionnaire-autopilot/supabase/bundles/20260213_cycle003_hosted_workflow_migration_plus_seed.sql"
      require_fallback_supabase_secrets:
        description: "If true, fail-fast unless NEXT_PUBLIC_SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY GitHub secrets exist (only needed for fallback evidence path)."
        type: boolean
        required: true
        default: false

jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      deployments: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Assemble + probe deployed BASE_URL candidates (always)
        id: basecands
        env:
          BASE_URL_CANDIDATES: ${{ inputs.base_url || inputs.base_url_candidates }}
          HOSTED_WORKFLOW_BASE_URL_CANDIDATES: ${{ vars.HOSTED_WORKFLOW_BASE_URL_CANDIDATES }}
          CYCLE_005_BASE_URL_CANDIDATES: ${{ vars.CYCLE_005_BASE_URL_CANDIDATES }}
          HOSTED_BASE_URL_CANDIDATES: ${{ vars.HOSTED_BASE_URL_CANDIDATES }}
          WORKFLOW_APP_BASE_URL_CANDIDATES: ${{ vars.WORKFLOW_APP_BASE_URL_CANDIDATES }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          mkdir -p preflight

          # Mirror select-hosted-base-url.sh precedence so the probe output matches selection behavior.
          candidate_source=""
          candidates=""
          if [ -n "${BASE_URL_CANDIDATES:-}" ]; then
            candidate_source="workflow_dispatch input (base_url/base_url_candidates)"
            candidates="${BASE_URL_CANDIDATES}"
          elif [ -n "${HOSTED_WORKFLOW_BASE_URL_CANDIDATES:-}" ]; then
            candidate_source="repo variable HOSTED_WORKFLOW_BASE_URL_CANDIDATES"
            candidates="${HOSTED_WORKFLOW_BASE_URL_CANDIDATES}"
          elif [ -n "${CYCLE_005_BASE_URL_CANDIDATES:-}" ]; then
            candidate_source="repo variable CYCLE_005_BASE_URL_CANDIDATES (legacy)"
            candidates="${CYCLE_005_BASE_URL_CANDIDATES}"
          elif [ -n "${HOSTED_BASE_URL_CANDIDATES:-}" ]; then
            candidate_source="repo variable HOSTED_BASE_URL_CANDIDATES (legacy)"
            candidates="${HOSTED_BASE_URL_CANDIDATES}"
          elif [ -n "${WORKFLOW_APP_BASE_URL_CANDIDATES:-}" ]; then
            candidate_source="repo variable WORKFLOW_APP_BASE_URL_CANDIDATES (legacy)"
            candidates="${WORKFLOW_APP_BASE_URL_CANDIDATES}"
          else
            candidate_source="GitHub Deployments discovery (best-effort)"
            candidates="$(
              ./projects/security-questionnaire-autopilot/scripts/collect-base-url-candidates-from-github-deployments.sh \
                | tr '\n' ' ' | tr -s ' ' | sed 's/^ *//; s/ *$//' || true
            )"
          fi

          printf '%s\n' "${candidates:-}" > preflight/base-url-candidates.txt
          printf '%s\n' "${candidate_source:-}" > preflight/base-url-source.txt
          if [ -n "${candidates:-}" ]; then
            ./projects/security-questionnaire-autopilot/scripts/probe-hosted-base-url-candidates.sh "${candidates}" \
              | tee preflight/base-url-probe.txt
          else
            printf '%s\n' "No BASE_URL candidates available after discovery." > preflight/base-url-probe.txt
          fi

      - name: Upload BASE_URL probe artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cycle-005-hosted-base-url-probe
          if-no-files-found: warn
          path: |
            preflight/base-url-candidates.txt
            preflight/base-url-source.txt
            preflight/base-url-probe.txt

      - name: Select + validate deployed BASE_URL (fail-fast)
        id: baseurl
        run: |
          set -euo pipefail

          candidates="$(cat preflight/base-url-candidates.txt 2>/dev/null || true)"
          candidates="$(printf '%s' "$candidates" | tr '\n' ' ' | tr -s ' ' | sed 's/^ *//; s/ *$//')"
          export BASE_URL_CANDIDATES="${candidates:-}"

          BASE_URL="$(./projects/security-questionnaire-autopilot/scripts/select-hosted-base-url.sh)"
          echo "Selected BASE_URL: $BASE_URL"
          echo "base_url=$BASE_URL" >> "$GITHUB_OUTPUT"

          candidate_source="$(cat preflight/base-url-source.txt 2>/dev/null || true)"
          {
            echo "## Cycle 005 Hosted Persistence Evidence"
            echo ""
            echo "- Selected BASE_URL: \`$BASE_URL\`"
            echo "- Candidate source: \`${candidate_source:-unknown}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Preflight: env-health (capture + enforce)
        env:
          BASE_URL: ${{ steps.baseurl.outputs.base_url }}
        run: |
          set -euo pipefail

          mkdir -p preflight
          out="preflight/env-health.json"
          code="$(curl -sS -m 12 -o "$out" -w "%{http_code}" "$BASE_URL/api/workflow/env-health" || echo "000")"
          if [ "$code" != "200" ]; then
            echo "env-health failed (HTTP $code): $BASE_URL/api/workflow/env-health" >&2
            cat "$out" >&2 || true
            exit 2
          fi

          jq -e '.' "$out" >/dev/null
          jq -e '.ok == true' "$out" >/dev/null

          has_env="$(jq -r '.env.NEXT_PUBLIC_SUPABASE_URL == true and .env.SUPABASE_SERVICE_ROLE_KEY == true' "$out" 2>/dev/null || echo "false")"

          {
            echo ""
            echo "- env-health: \`$BASE_URL/api/workflow/env-health\`"
            echo "- has_supabase_env: \`$has_env\`"
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "$has_env" != "true" ]; then
            echo "Hosted runtime is missing required Supabase env vars." >&2
            echo "Expected: NEXT_PUBLIC_SUPABASE_URL=true and SUPABASE_SERVICE_ROLE_KEY=true" >&2
            jq . "$out" >&2 || true
            exit 2
          fi

      - name: Preflight: supabase-health (env + schema + seed) (only when skip_sql_apply=true)
        if: ${{ inputs.skip_sql_apply }}
        env:
          BASE_URL: ${{ steps.baseurl.outputs.base_url }}
        run: |
          set -euo pipefail
          mkdir -p preflight
          out="preflight/supabase-health.json"
          code="$(curl -sS -m 12 -o "$out" -w "%{http_code}" "$BASE_URL/api/workflow/supabase-health?requireSeed=1&requirePilotDeals=1" || echo "000")"
          if [ "$code" != "200" ]; then
            echo "supabase-health failed (HTTP $code): $BASE_URL/api/workflow/supabase-health?requireSeed=1&requirePilotDeals=1" >&2
            cat "$out" >&2 || true
            exit 2
          fi
          jq -e '.' "$out" >/dev/null
          jq -e '.ok == true' "$out" >/dev/null

          expected="$(jq -r '.schema.expected_schema_bundle_id // empty' "$out" 2>/dev/null || true)"
          actual="$(jq -r '.schema.actual_schema_bundle_id // empty' "$out" 2>/dev/null || true)"

          {
            echo ""
            echo "- supabase-health: \`$BASE_URL/api/workflow/supabase-health?requireSeed=1&requirePilotDeals=1\`"
            echo "- schema_expected: \`$expected\`"
            echo "- schema_actual: \`$actual\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload preflight artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cycle-005-hosted-preflight
          if-no-files-found: warn
          path: |
            preflight/base-url-candidates.txt
            preflight/base-url-source.txt
            preflight/base-url-probe.txt
            preflight/env-health.json
            preflight/supabase-health.json

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: "projects/security-questionnaire-autopilot/.nvmrc"
          cache: "npm"
          cache-dependency-path: "projects/security-questionnaire-autopilot/package-lock.json"

      - name: Preflight: verify SQL bundle is internally consistent (drift guard)
        env:
          SQL_BUNDLE: ${{ inputs.sql_bundle }}
        run: |
          set -euo pipefail

          test -n "${SQL_BUNDLE:-}" || (echo "Missing input: sql_bundle" >&2; exit 2)
          test -f "${GITHUB_WORKSPACE}/${SQL_BUNDLE}" || (echo "Bundle not found: ${SQL_BUNDLE}" >&2; exit 2)
          cd projects/security-questionnaire-autopilot
          node scripts/verify-dashboard-sql-bundle.mjs --bundle "${GITHUB_WORKSPACE}/${SQL_BUNDLE}" >/dev/null

      - name: Install deps (hosted app)
        working-directory: projects/security-questionnaire-autopilot
        run: npm ci

      - name: Preflight: required secrets (clear error messages)
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          SKIP_SQL_APPLY: ${{ inputs.skip_sql_apply }}
          REQUIRE_FALLBACK: ${{ inputs.require_fallback_supabase_secrets }}
        run: |
          set -euo pipefail
          if [ "${SKIP_SQL_APPLY:-true}" != "true" ]; then
            test -n "${SUPABASE_DB_URL:-}" || (echo "Missing secret: SUPABASE_DB_URL (required when skip_sql_apply=false)" >&2; exit 2)
          fi
          if [ "${REQUIRE_FALLBACK:-false}" = "true" ]; then
            test -n "${NEXT_PUBLIC_SUPABASE_URL:-}" || (echo "Missing secret: NEXT_PUBLIC_SUPABASE_URL (required when require_fallback_supabase_secrets=true)" >&2; exit 2)
            test -n "${SUPABASE_SERVICE_ROLE_KEY:-}" || (echo "Missing secret: SUPABASE_SERVICE_ROLE_KEY (required when require_fallback_supabase_secrets=true)" >&2; exit 2)
          fi

      - name: Run hosted workflow + collect DB evidence (Cycle 005 wrapper)
        id: wrapper
        env:
          BASE_URL: ${{ steps.baseurl.outputs.base_url }}
          INPUT_RUN_ID: ${{ inputs.run_id }}
          SKIP_SQL_APPLY: ${{ inputs.skip_sql_apply }}
          SQL_BUNDLE: ${{ inputs.sql_bundle }}
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          set -euo pipefail

          test -n "${BASE_URL:-}" || (echo "Missing/invalid input: base_url" >&2; exit 2)

          RUN_ID="${INPUT_RUN_ID:-}"
          if [ -z "$RUN_ID" ]; then
            RUN_ID="pilot-001-customer-originated-db-$(date +%Y%m%d-%H%M%S)-gha-${GITHUB_RUN_ID}"
          fi

          if [ "${SKIP_SQL_APPLY:-true}" = "true" ]; then
            export SKIP_SUPABASE_SQL_APPLY=1
          else
            export SKIP_SUPABASE_SQL_APPLY=""
            test -n "${SUPABASE_DB_URL:-}" || (echo "Missing secret: SUPABASE_DB_URL (required when skip_sql_apply=false)" >&2; exit 2)
            test -f "${GITHUB_WORKSPACE}/${SQL_BUNDLE}" || (echo "Bundle not found: ${SQL_BUNDLE}" >&2; exit 2)
          fi

          ./projects/security-questionnaire-autopilot/scripts/cycle-005-hosted-supabase-apply-and-run.sh "$BASE_URL" "$RUN_ID"

          echo "run_id=$RUN_ID" >> "$GITHUB_OUTPUT"
          {
            echo ""
            echo "- run_id: \`$RUN_ID\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Post-run smoke: runtime + db-evidence (fail-fast)
        env:
          BASE_URL: ${{ steps.baseurl.outputs.base_url }}
          RUN_ID: ${{ steps.wrapper.outputs.run_id }}
        run: |
          set -euo pipefail
          mkdir -p preflight/postrun
          OUT_DIR="preflight/postrun" \
            ./projects/security-questionnaire-autopilot/scripts/smoke-hosted-runtime.sh "$BASE_URL" "$RUN_ID" \
              >/dev/null
          jq -e '.ok == true' preflight/postrun/smoke-summary.json >/dev/null

      - name: Verify evidence was appended to sales ledger
        env:
          RUN_ID: ${{ steps.wrapper.outputs.run_id }}
          SALES_DOC: docs/sales/cycle-003-hosted-workflow-pilot-001-execution.md
        run: |
          set -euo pipefail
          test -n "${RUN_ID:-}" || (echo "Missing wrapper output: run_id" >&2; exit 2)
          test -f "$SALES_DOC" || (echo "Missing sales ledger: $SALES_DOC" >&2; exit 2)

          if ! grep -Fq "run_id=${RUN_ID}" "$SALES_DOC"; then
            echo "Sales ledger does not contain expected evidence entry (run_id=${RUN_ID})." >&2
            exit 2
          fi

          META="$(ls -t docs/devops/cycle-005-hosted-supabase-run-metadata-*.txt 2>/dev/null | head -n 1 || true)"
          test -n "$META" || (echo "Missing metadata file: docs/devops/cycle-005-hosted-supabase-run-metadata-*.txt" >&2; exit 2)

          EVIDENCE="$(grep -E '^evidence=' "$META" | head -n 1 | cut -d= -f2-)"
          test -n "$EVIDENCE" || (echo "Metadata missing evidence= path: $META" >&2; exit 2)
          test -f "$EVIDENCE" || (echo "Evidence JSON missing: $EVIDENCE (from $META)" >&2; exit 2)

      - name: Upload evidence artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cycle-005-hosted-persistence-evidence
          if-no-files-found: warn
          path: |
            preflight/postrun/smoke-summary.json
            preflight/postrun/env-health.json
            preflight/postrun/supabase-health.json
            preflight/postrun/db-evidence.json
            docs/qa/cycle-005-*.json
            docs/devops/cycle-005-*.json
            docs/devops/cycle-005-*.txt
            docs/sales/cycle-003-hosted-workflow-pilot-001-execution.md

      - name: Create PR with appended evidence entry
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          title: "Cycle 005: hosted Supabase persistence evidence"
          commit-message: "Cycle 005: append hosted Supabase persistence evidence"
          branch: "cycle-005-hosted-persistence-evidence-${{ github.run_id }}"
          delete-branch: true
          add-paths: |
            docs/qa/cycle-005-*.json
            docs/devops/cycle-005-*.json
            docs/devops/cycle-005-*.txt
            docs/sales/cycle-003-hosted-workflow-pilot-001-execution.md
